# 09. CASE Statements and Conditional Logic

**Chapter:** SQL Fundamentals & Relational Databases
**Topic:** Implementing conditional logic and data transformations using CASE expressions

---

## 📋 Overview

SQL isn't just about retrieving data - it's about transforming and categorizing it to answer business questions. The CASE expression is SQL's primary tool for conditional logic, allowing you to implement if-then-else logic directly in your queries.

Think of CASE as SQL's version of if-else statements in programming languages. It lets you create new categories, transform values conditionally, handle NULLs gracefully, and implement complex business rules - all within a single SQL statement.

CASE expressions appear everywhere in analytics: customer segmentation, data cleaning, calculated fields, conditional aggregations, and pivot-like transformations. They're essential for transforming raw data into business-friendly reports and implementing data quality rules in ETL pipelines.

**Real-World Applications:**
- Customer segmentation: Categorize customers into tiers based on spending, behavior, or demographics
- Data transformation: Convert codes to descriptions, standardize values, clean messy data
- Conditional aggregation: Count/sum only rows meeting specific conditions
- Pivot operations: Transform rows into columns for reporting
- Business rules: Apply complex conditional logic (discounts, pricing tiers, status calculations)

---

## 🎯 Learning Objectives

After completing this subchapter, you will be able to:
- Write simple CASE expressions for value transformation
- Use searched CASE expressions for complex conditions
- Implement multi-level conditional logic
- Combine CASE with aggregate functions for conditional aggregations
- Use CASE in SELECT, WHERE, ORDER BY, and GROUP BY clauses
- Handle NULL values gracefully with CASE
- Create pivot-like transformations using CASE
- Optimize CASE expressions for readability and performance
- Understand COALESCE and NULLIF as CASE shortcuts
- Apply CASE for data quality and validation rules

---

## 📚 Core Concepts

### 1. CASE Expression Syntax

SQL has two forms of CASE expressions: **Simple CASE** and **Searched CASE**.

#### Simple CASE

Compares an expression to a set of simple values.

```sql
CASE expression
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ...
    ELSE default_result
END
```

#### Searched CASE

Evaluates a set of Boolean expressions.

```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ...
    ELSE default_result
END
```

**Key Point:** Searched CASE is more flexible and commonly used.

---

### 2. Simple CASE - Value Matching

Use when comparing one column to multiple values.

```sql
-- Convert order status codes to readable labels
SELECT
    order_id,
    status_code,
    CASE status_code
        WHEN 1 THEN 'Pending'
        WHEN 2 THEN 'Processing'
        WHEN 3 THEN 'Shipped'
        WHEN 4 THEN 'Delivered'
        WHEN 5 THEN 'Cancelled'
        ELSE 'Unknown'
    END AS status_description
FROM orders;
```

**Result:**
```
order_id | status_code | status_description
---------|-------------|-------------------
101      | 1           | Pending
102      | 3           | Shipped
103      | 4           | Delivered
104      | 99          | Unknown  ← ELSE clause
```

**Important:** Simple CASE uses `=` for comparison, so it can't handle NULL (use searched CASE for NULL checks).

---

### 3. Searched CASE - Conditional Logic

Use for complex conditions, ranges, and Boolean expressions.

```sql
-- Customer segmentation based on spending
SELECT
    customer_id,
    customer_name,
    total_spent,
    CASE
        WHEN total_spent > 10000 THEN 'Premium'
        WHEN total_spent > 5000 THEN 'Gold'
        WHEN total_spent > 1000 THEN 'Silver'
        ELSE 'Bronze'
    END AS customer_tier
FROM customers;
```

**Result:**
```
customer_id | customer_name | total_spent | customer_tier
------------|---------------|-------------|-------------
1           | Alice         | 15000       | Premium
2           | Bob           | 7500        | Gold
3           | Carol         | 3000        | Silver
4           | Dave          | 500         | Bronze
```

**Evaluation Order:** CASE evaluates conditions **top-to-bottom** and returns the **first match**.

---

### 4. ELSE Clause - Default Value

The ELSE clause provides a default value when no conditions match.

```sql
CASE
    WHEN price > 1000 THEN 'Expensive'
    WHEN price > 500 THEN 'Moderate'
    WHEN price > 100 THEN 'Affordable'
    ELSE 'Budget'  -- Handles all other cases
END
```

**Without ELSE:**
```sql
CASE
    WHEN price > 1000 THEN 'Expensive'
    WHEN price > 500 THEN 'Moderate'
    -- No ELSE: Returns NULL if no match
END
```

**Best Practice:** Always include ELSE to handle unexpected values and make behavior explicit.

---

### 5. CASE in SELECT Clause

Most common usage: creating calculated columns.

```sql
-- Add discount tier to products
SELECT
    product_id,
    product_name,
    price,
    CASE
        WHEN price > 1000 THEN price * 0.90  -- 10% discount
        WHEN price > 500  THEN price * 0.95  -- 5% discount
        ELSE price                           -- No discount
    END AS discounted_price,
    CASE
        WHEN price > 1000 THEN '10%'
        WHEN price > 500  THEN '5%'
        ELSE '0%'
    END AS discount_rate
FROM products;
```

---

### 6. CASE in WHERE Clause

Apply conditional filtering logic.

```sql
-- Different filters for different product categories
SELECT product_name, category, price
FROM products
WHERE
    CASE
        WHEN category = 'Electronics' THEN price > 500
        WHEN category = 'Clothing'    THEN price > 100
        WHEN category = 'Books'       THEN price > 20
        ELSE price > 50
    END = TRUE;
```

**Alternative (often clearer):** Use OR conditions instead:
```sql
WHERE (category = 'Electronics' AND price > 500)
   OR (category = 'Clothing' AND price > 100)
   ...
```

---

### 7. CASE in ORDER BY

Custom sorting logic.

```sql
-- Sort by custom priority: Premium > Gold > Silver > Bronze
SELECT
    customer_name,
    customer_tier
FROM customers
ORDER BY
    CASE customer_tier
        WHEN 'Premium' THEN 1
        WHEN 'Gold'    THEN 2
        WHEN 'Silver'  THEN 3
        WHEN 'Bronze'  THEN 4
        ELSE 5
    END,
    customer_name;  -- Then alphabetically within tier
```

---

### 8. CASE in GROUP BY

Group by conditional categories.

```sql
-- Group products into price ranges
SELECT
    CASE
        WHEN price < 100  THEN 'Under $100'
        WHEN price < 500  THEN '$100-$500'
        WHEN price < 1000 THEN '$500-$1000'
        ELSE '$1000+'
    END AS price_range,
    COUNT(*) AS product_count,
    AVG(price) AS avg_price
FROM products
GROUP BY
    CASE
        WHEN price < 100  THEN 'Under $100'
        WHEN price < 500  THEN '$100-$500'
        WHEN price < 1000 THEN '$500-$1000'
        ELSE '$1000+'
    END
ORDER BY MIN(price);
```

**Better with CTE for readability:**
```sql
WITH price_categories AS (
    SELECT
        *,
        CASE
            WHEN price < 100  THEN 'Under $100'
            WHEN price < 500  THEN '$100-$500'
            WHEN price < 1000 THEN '$500-$1000'
            ELSE '$1000+'
        END AS price_range
    FROM products
)
SELECT
    price_range,
    COUNT(*) AS product_count,
    AVG(price) AS avg_price
FROM price_categories
GROUP BY price_range;
```

---

### 9. Conditional Aggregation

Use CASE inside aggregate functions to count/sum only specific rows.

```sql
-- Count orders by status in one query
SELECT
    customer_id,
    COUNT(*) AS total_orders,
    SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) AS completed_orders,
    SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) AS cancelled_orders,
    SUM(CASE WHEN status = 'pending'   THEN 1 ELSE 0 END) AS pending_orders
FROM orders
GROUP BY customer_id;
```

**Result:**
```
customer_id | total_orders | completed_orders | cancelled_orders | pending_orders
------------|--------------|------------------|------------------|---------------
1           | 10           | 8                | 1                | 1
2           | 5            | 4                | 0                | 1
```

**Alternative using COUNT:**
```sql
-- COUNT ignores NULLs, so CASE can return NULL instead of 0
SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END)  -- SUM approach
COUNT(CASE WHEN status = 'completed' THEN 1 END)       -- COUNT approach (same result)
```

---

### 10. Pivot Transformations with CASE

Transform rows into columns for reporting.

```sql
-- Pivot sales by quarter
SELECT
    product_id,
    product_name,
    SUM(CASE WHEN quarter = 'Q1' THEN sales ELSE 0 END) AS Q1_sales,
    SUM(CASE WHEN quarter = 'Q2' THEN sales ELSE 0 END) AS Q2_sales,
    SUM(CASE WHEN quarter = 'Q3' THEN sales ELSE 0 END) AS Q3_sales,
    SUM(CASE WHEN quarter = 'Q4' THEN sales ELSE 0 END) AS Q4_sales,
    SUM(sales) AS total_annual_sales
FROM quarterly_sales
GROUP BY product_id, product_name;
```

**Result:**
```
product_id | product_name | Q1_sales | Q2_sales | Q3_sales | Q4_sales | total
-----------|--------------|----------|----------|----------|----------|-------
1          | Laptop       | 5000     | 7000     | 6000     | 8000     | 26000
2          | Mouse        | 300      | 450      | 400      | 600      | 1750
```

---

### 11. Nested CASE Expressions

CASE expressions can be nested for complex multi-level logic.

```sql
-- Complex shipping fee calculation
SELECT
    order_id,
    total_amount,
    country,
    CASE
        WHEN country = 'USA' THEN
            CASE
                WHEN total_amount > 100 THEN 0       -- Free shipping
                WHEN total_amount > 50  THEN 5.99
                ELSE 9.99
            END
        WHEN country IN ('Canada', 'Mexico') THEN
            CASE
                WHEN total_amount > 150 THEN 0
                ELSE 14.99
            END
        ELSE 24.99  -- International
    END AS shipping_fee
FROM orders;
```

**Readability Tip:** Limit nesting to 2 levels; beyond that, use CTEs or multiple CASE statements.

---

## 💡 Practical Examples

### Example 1: Customer Lifetime Value Segmentation

```sql
-- Segment customers by LTV and recency
SELECT
    customer_id,
    customer_name,
    total_spent,
    days_since_last_order,
    CASE
        WHEN total_spent > 10000 AND days_since_last_order < 30 THEN 'VIP Active'
        WHEN total_spent > 10000 AND days_since_last_order >= 30 THEN 'VIP At Risk'
        WHEN total_spent > 5000 AND days_since_last_order < 60 THEN 'High Value Active'
        WHEN total_spent > 5000 AND days_since_last_order >= 60 THEN 'High Value At Risk'
        WHEN days_since_last_order > 180 THEN 'Churned'
        ELSE 'Standard'
    END AS customer_segment
FROM customers
ORDER BY total_spent DESC;
```

---

### Example 2: Data Quality Flags

```sql
-- Flag data quality issues
SELECT
    customer_id,
    email,
    phone,
    address,
    CASE
        WHEN email IS NULL AND phone IS NULL THEN 'Critical: No Contact Info'
        WHEN email IS NULL THEN 'Warning: No Email'
        WHEN phone IS NULL THEN 'Warning: No Phone'
        WHEN address IS NULL THEN 'Warning: No Address'
        ELSE 'OK'
    END AS data_quality_status
FROM customers
WHERE
    CASE
        WHEN email IS NULL AND phone IS NULL THEN TRUE
        WHEN email IS NULL OR phone IS NULL OR address IS NULL THEN TRUE
        ELSE FALSE
    END = TRUE;
```

---

### Example 3: Dynamic Pricing

```sql
-- Apply different discount rules by category and inventory
SELECT
    product_id,
    product_name,
    category,
    price,
    quantity_in_stock,
    CASE
        -- Clearance: Low stock electronics
        WHEN category = 'Electronics' AND quantity_in_stock < 5 THEN price * 0.70
        -- Holiday sale: Toys and Games
        WHEN category IN ('Toys', 'Games') AND CURRENT_DATE BETWEEN '2024-11-01' AND '2024-12-31'
            THEN price * 0.80
        -- Volume discount: Overstocked items
        WHEN quantity_in_stock > 100 THEN price * 0.90
        -- Regular price
        ELSE price
    END AS sale_price,
    CASE
        WHEN category = 'Electronics' AND quantity_in_stock < 5 THEN '30% OFF - Clearance'
        WHEN category IN ('Toys', 'Games') AND CURRENT_DATE BETWEEN '2024-11-01' AND '2024-12-31'
            THEN '20% OFF - Holiday Sale'
        WHEN quantity_in_stock > 100 THEN '10% OFF - Overstocked'
        ELSE 'Regular Price'
    END AS promotion
FROM products;
```

---

### Example 4: Conditional Aggregation for Reports

```sql
-- Sales performance dashboard
SELECT
    salesperson_id,
    salesperson_name,
    -- Sales by category
    SUM(CASE WHEN category = 'Electronics' THEN sale_amount ELSE 0 END) AS electronics_sales,
    SUM(CASE WHEN category = 'Furniture' THEN sale_amount ELSE 0 END) AS furniture_sales,
    SUM(CASE WHEN category = 'Clothing' THEN sale_amount ELSE 0 END) AS clothing_sales,
    -- Sales by quarter
    SUM(CASE WHEN EXTRACT(QUARTER FROM sale_date) = 1 THEN sale_amount ELSE 0 END) AS Q1_sales,
    SUM(CASE WHEN EXTRACT(QUARTER FROM sale_date) = 2 THEN sale_amount ELSE 0 END) AS Q2_sales,
    SUM(CASE WHEN EXTRACT(QUARTER FROM sale_date) = 3 THEN sale_amount ELSE 0 END) AS Q3_sales,
    SUM(CASE WHEN EXTRACT(QUARTER FROM sale_date) = 4 THEN sale_amount ELSE 0 END) AS Q4_sales,
    -- Performance metrics
    SUM(sale_amount) AS total_sales,
    COUNT(*) AS total_transactions,
    AVG(sale_amount) AS avg_transaction_value
FROM sales
WHERE sale_date >= '2024-01-01'
GROUP BY salesperson_id, salesperson_name
ORDER BY total_sales DESC;
```

---

## 🔧 Code Examples

### COALESCE - NULL Handling Shortcut

COALESCE returns the first non-NULL value in a list (syntactic sugar for CASE).

```sql
-- COALESCE
SELECT COALESCE(email, phone, 'No contact info') AS contact
FROM customers;

-- Equivalent CASE
SELECT
    CASE
        WHEN email IS NOT NULL THEN email
        WHEN phone IS NOT NULL THEN phone
        ELSE 'No contact info'
    END AS contact
FROM customers;
```

---

### NULLIF - Avoiding Division by Zero

NULLIF returns NULL if two values are equal (useful for avoiding division by zero).

```sql
-- NULLIF
SELECT
    total_revenue,
    total_orders,
    total_revenue / NULLIF(total_orders, 0) AS avg_order_value
FROM sales_summary;

-- Equivalent CASE
SELECT
    total_revenue,
    total_orders,
    total_revenue / CASE WHEN total_orders = 0 THEN NULL ELSE total_orders END AS avg_order_value
FROM sales_summary;
```

**Why this works:** Division by NULL returns NULL, not an error.

---

### IIF - Binary Conditional (SQL Server, PostgreSQL)

Some databases support IIF for simple true/false conditions.

```sql
-- IIF (SQL Server, PostgreSQL)
SELECT IIF(price > 100, 'Expensive', 'Affordable') AS price_category
FROM products;

-- Equivalent CASE
SELECT CASE WHEN price > 100 THEN 'Expensive' ELSE 'Affordable' END AS price_category
FROM products;
```

---

## ✅ Best Practices

### 1. Always Include ELSE

```sql
-- ✅ Good: Explicit default
CASE
    WHEN status = 'active' THEN 'Active'
    ELSE 'Inactive'  -- Handles NULL, unexpected values
END

-- ❌ Risky: Implicit NULL
CASE
    WHEN status = 'active' THEN 'Active'
    -- NULL if status != 'active'
END
```

### 2. Order Conditions from Most to Least Specific

```sql
-- ✅ Good: Specific to general
CASE
    WHEN total_spent > 10000 THEN 'Premium'  -- Most specific
    WHEN total_spent > 5000 THEN 'Gold'
    WHEN total_spent > 1000 THEN 'Silver'
    ELSE 'Bronze'  -- Catch-all
END

-- ❌ Wrong: General conditions first (unreachable code)
CASE
    WHEN total_spent > 0 THEN 'Customer'      -- Matches everyone!
    WHEN total_spent > 10000 THEN 'Premium'   -- Never reached
    ...
END
```

### 3. Use CTEs for Complex CASE Logic

```sql
-- ✅ Good: Readable CTE
WITH categorized_customers AS (
    SELECT
        *,
        CASE
            WHEN total_spent > 10000 THEN 'Premium'
            WHEN total_spent > 5000 THEN 'Gold'
            WHEN total_spent > 1000 THEN 'Silver'
            ELSE 'Bronze'
        END AS tier
    FROM customers
)
SELECT tier, COUNT(*), AVG(total_spent)
FROM categorized_customers
GROUP BY tier;

-- ❌ Harder to read: Repeated CASE in GROUP BY
SELECT
    CASE WHEN total_spent > 10000 THEN 'Premium' ... END AS tier,
    COUNT(*),
    AVG(total_spent)
FROM customers
GROUP BY CASE WHEN total_spent > 10000 THEN 'Premium' ... END;
```

### 4. Use COALESCE for NULL Defaults

```sql
-- ✅ Good: Concise
SELECT COALESCE(email, phone, 'Unknown')

-- ❌ Verbose: Unnecessary CASE
SELECT CASE
    WHEN email IS NOT NULL THEN email
    WHEN phone IS NOT NULL THEN phone
    ELSE 'Unknown'
END
```

### 5. Avoid Complex Nesting

```sql
-- ❌ Hard to read: 3+ levels of nesting
CASE
    WHEN condition1 THEN
        CASE
            WHEN condition2 THEN
                CASE WHEN condition3 THEN ... END
            ELSE ...
        END
    ELSE ...
END

-- ✅ Better: Multiple CASE statements or CTEs
WITH step1 AS (
    SELECT *, CASE WHEN condition1 THEN value1 ELSE value2 END AS result1
    FROM table
),
step2 AS (
    SELECT *, CASE WHEN condition2 THEN value3 ELSE value4 END AS result2
    FROM step1
)
SELECT * FROM step2;
```

---

## ⚠️ Common Pitfalls

### 1. Order of Conditions Matters

```sql
-- ❌ Wrong: All values > 1000 match first condition!
CASE
    WHEN price > 1000 THEN 'Expensive'
    WHEN price > 5000 THEN 'Very Expensive'  -- Never reached
    ...
END

-- ✅ Correct: Most specific first
CASE
    WHEN price > 5000 THEN 'Very Expensive'
    WHEN price > 1000 THEN 'Expensive'
    ...
END
```

### 2. Simple CASE Cannot Handle NULL

```sql
-- ❌ Won't match NULL values
CASE status
    WHEN NULL THEN 'No Status'  -- Never matches (NULL != NULL)
    ...
END

-- ✅ Use searched CASE
CASE
    WHEN status IS NULL THEN 'No Status'
    ...
END
```

### 3. Data Type Mismatches

```sql
-- ❌ Error: Cannot mix types
CASE
    WHEN price > 1000 THEN 'Expensive'  -- String
    ELSE price                           -- Number
END

-- ✅ Consistent data types
CASE
    WHEN price > 1000 THEN 'Expensive'
    ELSE CAST(price AS VARCHAR)
END
```

### 4. Forgetting to Handle All Cases

```sql
-- ❌ Missing ELSE: Returns NULL for unexpected status
CASE status
    WHEN 'active' THEN 'Active'
    WHEN 'inactive' THEN 'Inactive'
    -- What if status = 'pending', 'suspended', NULL, etc.?
END

-- ✅ Explicit default
CASE status
    WHEN 'active' THEN 'Active'
    WHEN 'inactive' THEN 'Inactive'
    ELSE 'Other'  -- Or 'Unknown', or COALESCE(status, 'Null Status')
END
```

### 5. Division by Zero

```sql
-- ❌ Can cause division by zero error
SELECT revenue / order_count

-- ✅ Use NULLIF or CASE
SELECT revenue / NULLIF(order_count, 0)
-- Or
SELECT CASE WHEN order_count > 0 THEN revenue / order_count ELSE NULL END
```

---

## 🏋️ Hands-On Exercises

### Exercise 1: Basic CASE
Write a query to categorize products by price:
- Under $50: "Budget"
- $50-$200: "Standard"
- $200-$1000: "Premium"
- Over $1000: "Luxury"

### Exercise 2: Searched CASE with Multiple Conditions
Create customer risk scores based on:
- High risk: No email AND no phone
- Medium risk: Missing email OR missing phone
- Low risk: Has both email and phone

### Exercise 3: Conditional Aggregation
Write a single query showing:
- Total orders
- Count of orders by status (completed, pending, cancelled, shipped)
- Total revenue by status
- Percentage of orders in each status

### Exercise 4: Pivot Transformation
Transform monthly sales data from rows to columns:
- Input: (product_id, month, sales)
- Output: (product_id, Jan_sales, Feb_sales, Mar_sales, ...)

### Exercise 5: Complex Business Logic
Implement a dynamic shipping fee calculator:
- USA: Free if total > $50, else $5.99
- Canada: Free if total > $100, else $9.99
- International: Free if total > $200, else $24.99
- Expedited shipping (if selected): Add $15 to any tier

### Exercise 6: Data Quality Report
Create a data quality score for customer records:
- 100: All fields (email, phone, address, city, zip) populated
- 80: Missing 1 field
- 60: Missing 2 fields
- 40: Missing 3 fields
- 20: Missing 4+ fields

**Solutions:** Available in `Exercises/Chapter-05/Solutions/Exercise-09-Solutions.sql`

---

## 📚 Further Reading

### Official Documentation
- [PostgreSQL CASE Expressions](https://www.postgresql.org/docs/current/functions-conditional.html)
- [MySQL CASE Statement](https://dev.mysql.com/doc/refman/8.0/en/flow-control-functions.html#operator_case)
- [SQL Server CASE](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/case-transact-sql)

### Tutorials
- [SQL CASE Tutorial (Mode Analytics)](https://mode.com/sql-tutorial/sql-case/)
- [Conditional Logic in SQL](https://www.essentialsql.com/introduction-case-statement/)
- [Advanced CASE Patterns](https://www.sqlshack.com/case-statement-in-sql/)

---

## 📝 Key Takeaways

1. **Two forms:** Simple CASE (value matching) and Searched CASE (Boolean conditions)
2. **Always include ELSE** to handle unexpected values and avoid NULLs
3. **Order matters:** Conditions evaluated top-to-bottom, first match wins
4. **Simple CASE cannot check for NULL** - use searched CASE with IS NULL
5. **CASE works in SELECT, WHERE, ORDER BY, GROUP BY** - extremely versatile
6. **Conditional aggregation:** Combine CASE with SUM/COUNT for pivot-like results
7. **COALESCE:** Shortcut for returning first non-NULL value
8. **NULLIF:** Shortcut for converting specific values to NULL (division by zero)
9. **Data types must match:** All THEN/ELSE results must be same type
10. **Use CTEs for complex logic** instead of deeply nested CASE
11. **Limit nesting to 2 levels** for readability
12. **Conditional aggregation pattern:** `SUM(CASE WHEN condition THEN 1 ELSE 0 END)`
13. **Performance:** CASE is evaluated for each row; use indexes on condition columns
14. **Pivot pattern:** Create columns with `SUM(CASE WHEN col = 'value' THEN amount ELSE 0 END)`
15. **Essential for data transformation** - core skill for analytics and ETL

---

## 🔗 Related Concepts

- [[08. Window Functions|Previous: Window Functions]]
- [[10. Set Operations|Next: UNION, INTERSECT, EXCEPT]]
- [[04. Aggregate Functions|Related: Aggregate Functions]]
- [[03. Filtering and Logical Operators|Related: Boolean Logic]]

---

## ✏️ Notes Section

**My Key Insights:**
-

**Common CASE Patterns:**
-

**Business Rule Examples:**
-

---

*Created: October 21, 2025*
*Last Updated: October 21, 2025*
*Status: ✅ Complete - Ready for study*
