---
title: Date & Time Operations
date: 2025-10-14
tags: [sql, dates, timestamps, time-zones, date-arithmetic, data-engineering, temporal-data, core-skills]
status: active
learning_phase: "Core Skills (Practical Operations)"
---

# Date & Time Operations

## Overview

Date and time operations are among the most common tasks in data engineering. Whether analyzing time-series data, calculating durations, or handling time zones, mastering temporal SQL functions is essential.

---

## Date/Time Data Types

### Common Types

```sql
CREATE TABLE datetime_examples (
    -- Date only (no time component)
    order_date DATE,                     -- '2024-01-15'

    -- Time only (no date component)
    opening_time TIME,                   -- '09:00:00'

    -- Date and time (no timezone)
    created_at TIMESTAMP,                -- '2024-01-15 14:30:00'

    -- Date and time with timezone (PostgreSQL)
    updated_at TIMESTAMPTZ,              -- '2024-01-15 14:30:00+00'
    -- Or: TIMESTAMP WITH TIME ZONE

    -- Interval (duration)
    processing_time INTERVAL             -- '2 hours 30 minutes'
);
```

### Type Comparison

| Type | Storage | Time Zone | Use Case |
|------|---------|-----------|----------|
| **DATE** | 4 bytes | No | Birth dates, order dates |
| **TIME** | 8 bytes | No | Opening hours, schedules |
| **TIMESTAMP** | 8 bytes | No | Logs, audit trails (single TZ) |
| **TIMESTAMPTZ** | 8 bytes | Yes | Multi-region events |
| **INTERVAL** | 16 bytes | N/A | Durations, time differences |

---

## Getting Current Date/Time

```sql
-- Current date (no time)
SELECT CURRENT_DATE;                    -- '2024-01-15'
SELECT CURDATE();                       -- MySQL

-- Current timestamp (date + time)
SELECT CURRENT_TIMESTAMP;               -- '2024-01-15 14:30:45'
SELECT NOW();                           -- PostgreSQL, MySQL
SELECT GETDATE();                       -- SQL Server

-- Current time (no date)
SELECT CURRENT_TIME;                    -- '14:30:45'
SELECT CURTIME();                       -- MySQL

-- UTC timestamp (timezone-aware)
SELECT NOW() AT TIME ZONE 'UTC';        -- PostgreSQL
SELECT GETUTCDATE();                    -- SQL Server
```

---

## Date Arithmetic

### Adding/Subtracting Time

#### PostgreSQL

```sql
-- Add days
SELECT CURRENT_DATE + INTERVAL '7 days';              -- 7 days from now
SELECT CURRENT_DATE + 7;                              -- Same (shorthand)

-- Add various units
SELECT NOW() + INTERVAL '1 hour';                     -- 1 hour from now
SELECT NOW() + INTERVAL '30 minutes';                 -- 30 minutes from now
SELECT NOW() + INTERVAL '2 weeks';                    -- 2 weeks from now
SELECT NOW() + INTERVAL '3 months';                   -- 3 months from now
SELECT NOW() + INTERVAL '1 year';                     -- 1 year from now

-- Subtract time
SELECT CURRENT_DATE - INTERVAL '30 days';             -- 30 days ago
SELECT NOW() - INTERVAL '2 hours';                    -- 2 hours ago

-- Combine intervals
SELECT NOW() + INTERVAL '1 day 2 hours 30 minutes';
SELECT NOW() - INTERVAL '1 year 6 months';
```

#### MySQL

```sql
-- DATE_ADD and DATE_SUB
SELECT DATE_ADD(CURRENT_DATE, INTERVAL 7 DAY);        -- 7 days from now
SELECT DATE_SUB(CURRENT_DATE, INTERVAL 30 DAY);       -- 30 days ago

-- Various units
SELECT DATE_ADD(NOW(), INTERVAL 1 HOUR);
SELECT DATE_ADD(NOW(), INTERVAL 30 MINUTE);
SELECT DATE_ADD(NOW(), INTERVAL 1 WEEK);
SELECT DATE_ADD(NOW(), INTERVAL 3 MONTH);
SELECT DATE_ADD(NOW(), INTERVAL 1 YEAR);

-- Arithmetic operators
SELECT CURRENT_DATE + INTERVAL 7 DAY;
SELECT NOW() - INTERVAL 2 HOUR;
```

#### SQL Server

```sql
-- DATEADD function
SELECT DATEADD(DAY, 7, GETDATE());                    -- 7 days from now
SELECT DATEADD(HOUR, -2, GETDATE());                  -- 2 hours ago
SELECT DATEADD(MONTH, 3, GETDATE());                  -- 3 months from now
SELECT DATEADD(YEAR, 1, GETDATE());                   -- 1 year from now

-- Units: YEAR, QUARTER, MONTH, WEEK, DAY, HOUR, MINUTE, SECOND
```

### Calculating Differences

#### PostgreSQL

```sql
-- Difference between dates (returns integer days)
SELECT CURRENT_DATE - '2024-01-01'::DATE;             -- Days since Jan 1

-- Difference between timestamps (returns interval)
SELECT NOW() - '2024-01-01 00:00:00'::TIMESTAMP;      -- Interval

-- AGE function (human-readable interval)
SELECT AGE(CURRENT_DATE, '1990-05-15'::DATE);         -- '33 years 8 months 1 day'

-- Extract total days from interval
SELECT EXTRACT(EPOCH FROM (NOW() - '2024-01-01'::TIMESTAMP)) / 86400;
```

#### MySQL

```sql
-- DATEDIFF (returns days)
SELECT DATEDIFF(CURRENT_DATE, '2024-01-01');          -- Days difference

-- TIMEDIFF (returns time)
SELECT TIMEDIFF('2024-01-15 14:30:00', '2024-01-15 10:00:00');  -- '04:30:00'

-- TIMESTAMPDIFF (flexible units)
SELECT TIMESTAMPDIFF(DAY, '2024-01-01', CURRENT_DATE);      -- Days
SELECT TIMESTAMPDIFF(HOUR, '2024-01-15 10:00:00', NOW());   -- Hours
SELECT TIMESTAMPDIFF(MINUTE, '2024-01-15 10:00:00', NOW()); -- Minutes
SELECT TIMESTAMPDIFF(YEAR, '1990-05-15', CURRENT_DATE);     -- Years
```

#### SQL Server

```sql
-- DATEDIFF (returns integer)
SELECT DATEDIFF(DAY, '2024-01-01', GETDATE());        -- Days
SELECT DATEDIFF(HOUR, '2024-01-15 10:00:00', GETDATE());  -- Hours
SELECT DATEDIFF(MINUTE, '2024-01-15 10:00:00', GETDATE()); -- Minutes
SELECT DATEDIFF(YEAR, '1990-05-15', GETDATE());       -- Years

-- DATEDIFF_BIG for large intervals (returns bigint)
SELECT DATEDIFF_BIG(SECOND, '2020-01-01', GETDATE());
```

---

## Extracting Date/Time Components

### EXTRACT (Standard SQL)

```sql
-- Extract parts from date/timestamp
SELECT EXTRACT(YEAR FROM CURRENT_DATE);               -- 2024
SELECT EXTRACT(MONTH FROM CURRENT_DATE);              -- 1
SELECT EXTRACT(DAY FROM CURRENT_DATE);                -- 15
SELECT EXTRACT(HOUR FROM NOW());                      -- 14
SELECT EXTRACT(MINUTE FROM NOW());                    -- 30
SELECT EXTRACT(SECOND FROM NOW());                    -- 45

-- Extract week information
SELECT EXTRACT(WEEK FROM CURRENT_DATE);               -- Week of year
SELECT EXTRACT(DOW FROM CURRENT_DATE);                -- Day of week (0=Sun)
SELECT EXTRACT(DOY FROM CURRENT_DATE);                -- Day of year
SELECT EXTRACT(QUARTER FROM CURRENT_DATE);            -- Quarter (1-4)

-- PostgreSQL: EXTRACT(EPOCH) for Unix timestamp
SELECT EXTRACT(EPOCH FROM NOW());                     -- Seconds since 1970-01-01
```

### Database-Specific Functions

```sql
-- PostgreSQL
SELECT DATE_PART('year', NOW());                      -- Same as EXTRACT
SELECT TO_CHAR(NOW(), 'YYYY-MM-DD');                  -- Format as string

-- MySQL
SELECT YEAR(CURRENT_DATE);                            -- 2024
SELECT MONTH(CURRENT_DATE);                           -- 1
SELECT DAY(CURRENT_DATE);                             -- 15
SELECT HOUR(NOW());                                   -- 14
SELECT MINUTE(NOW());                                 -- 30
SELECT SECOND(NOW());                                 -- 45
SELECT QUARTER(CURRENT_DATE);                         -- 1
SELECT WEEK(CURRENT_DATE);                            -- Week number
SELECT DAYOFWEEK(CURRENT_DATE);                       -- 1=Sunday, 7=Saturday
SELECT DAYOFYEAR(CURRENT_DATE);                       -- Day of year
SELECT DAYNAME(CURRENT_DATE);                         -- 'Monday'
SELECT MONTHNAME(CURRENT_DATE);                       -- 'January'

-- SQL Server
SELECT YEAR(GETDATE());
SELECT MONTH(GETDATE());
SELECT DAY(GETDATE());
SELECT DATEPART(HOUR, GETDATE());
SELECT DATEPART(MINUTE, GETDATE());
SELECT DATEPART(QUARTER, GETDATE());
SELECT DATEPART(WEEK, GETDATE());
SELECT DATEPART(WEEKDAY, GETDATE());                  -- 1=Sunday
SELECT DATENAME(WEEKDAY, GETDATE());                  -- 'Monday'
SELECT DATENAME(MONTH, GETDATE());                    -- 'January'
```

---

## Truncating/Rounding Dates

### DATE_TRUNC (PostgreSQL)

```sql
-- Truncate to beginning of period
SELECT DATE_TRUNC('year', NOW());                     -- '2024-01-01 00:00:00'
SELECT DATE_TRUNC('month', NOW());                    -- '2024-01-01 00:00:00'
SELECT DATE_TRUNC('week', NOW());                     -- Start of week (Monday)
SELECT DATE_TRUNC('day', NOW());                      -- '2024-01-15 00:00:00'
SELECT DATE_TRUNC('hour', NOW());                     -- '2024-01-15 14:00:00'
SELECT DATE_TRUNC('minute', NOW());                   -- '2024-01-15 14:30:00'

-- Common use: Group by month
SELECT
    DATE_TRUNC('month', order_date) AS month,
    COUNT(*) AS order_count,
    SUM(total_amount) AS revenue
FROM orders
GROUP BY DATE_TRUNC('month', order_date)
ORDER BY month;
```

### DATE_FORMAT / DATE Functions

```sql
-- MySQL: Truncate to date only
SELECT DATE(NOW());                                   -- '2024-01-15'

-- Format to first day of month
SELECT DATE_FORMAT(NOW(), '%Y-%m-01');                -- '2024-01-01'

-- SQL Server: DATETRUNC (SQL Server 2022+)
SELECT DATETRUNC(YEAR, GETDATE());                    -- '2024-01-01'
SELECT DATETRUNC(MONTH, GETDATE());                   -- '2024-01-01'
SELECT DATETRUNC(DAY, GETDATE());                     -- '2024-01-15 00:00:00'

-- SQL Server: Manual truncation (older versions)
SELECT DATEADD(DAY, DATEDIFF(DAY, 0, GETDATE()), 0);         -- Midnight today
SELECT DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0);     -- First of month
SELECT DATEADD(YEAR, DATEDIFF(YEAR, 0, GETDATE()), 0);       -- First of year
```

---

## Formatting Dates

### TO_CHAR (PostgreSQL)

```sql
SELECT TO_CHAR(NOW(), 'YYYY-MM-DD');                  -- '2024-01-15'
SELECT TO_CHAR(NOW(), 'DD/MM/YYYY');                  -- '15/01/2024'
SELECT TO_CHAR(NOW(), 'Month DD, YYYY');              -- 'January 15, 2024'
SELECT TO_CHAR(NOW(), 'HH24:MI:SS');                  -- '14:30:45'
SELECT TO_CHAR(NOW(), 'Day, DD Month YYYY');          -- 'Monday, 15 January 2024'
SELECT TO_CHAR(NOW(), 'YYYY-MM-DD HH24:MI:SS');       -- '2024-01-15 14:30:45'

-- Common patterns
SELECT TO_CHAR(NOW(), 'FMMonth FMDD, YYYY');          -- 'January 15, 2024' (no padding)
SELECT TO_CHAR(NOW(), 'Q');                           -- '1' (quarter)
SELECT TO_CHAR(NOW(), 'WW');                          -- Week of year
```

### DATE_FORMAT (MySQL)

```sql
SELECT DATE_FORMAT(NOW(), '%Y-%m-%d');                -- '2024-01-15'
SELECT DATE_FORMAT(NOW(), '%d/%m/%Y');                -- '15/01/2024'
SELECT DATE_FORMAT(NOW(), '%M %d, %Y');               -- 'January 15, 2024'
SELECT DATE_FORMAT(NOW(), '%H:%i:%s');                -- '14:30:45'
SELECT DATE_FORMAT(NOW(), '%W, %M %d, %Y');           -- 'Monday, January 15, 2024'
SELECT DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s');       -- '2024-01-15 14:30:45'
```

### FORMAT / CONVERT (SQL Server)

```sql
SELECT FORMAT(GETDATE(), 'yyyy-MM-dd');               -- '2024-01-15'
SELECT FORMAT(GETDATE(), 'dd/MM/yyyy');               -- '15/01/2024'
SELECT FORMAT(GETDATE(), 'MMMM dd, yyyy');            -- 'January 15, 2024'
SELECT FORMAT(GETDATE(), 'HH:mm:ss');                 -- '14:30:45'

-- CONVERT with style codes
SELECT CONVERT(VARCHAR, GETDATE(), 23);               -- 'yyyy-mm-dd'
SELECT CONVERT(VARCHAR, GETDATE(), 103);              -- 'dd/mm/yyyy'
SELECT CONVERT(VARCHAR, GETDATE(), 101);              -- 'mm/dd/yyyy'
```

---

## Parsing Dates

### String to Date Conversion

```sql
-- PostgreSQL
SELECT '2024-01-15'::DATE;                            -- Cast
SELECT TO_DATE('2024-01-15', 'YYYY-MM-DD');           -- With format
SELECT TO_TIMESTAMP('2024-01-15 14:30:00', 'YYYY-MM-DD HH24:MI:SS');

-- MySQL
SELECT STR_TO_DATE('2024-01-15', '%Y-%m-%d');         -- Date
SELECT STR_TO_DATE('01/15/2024', '%m/%d/%Y');         -- Different format
SELECT STR_TO_DATE('January 15, 2024', '%M %d, %Y');  -- Text month

-- SQL Server
SELECT CAST('2024-01-15' AS DATE);
SELECT CONVERT(DATE, '2024-01-15');
SELECT PARSE('January 15, 2024' AS DATE);             -- SQL Server 2012+
```

---

## Time Zones

### Working with Time Zones (PostgreSQL)

```sql
-- Convert to specific timezone
SELECT NOW() AT TIME ZONE 'UTC';                      -- Convert to UTC
SELECT NOW() AT TIME ZONE 'America/New_York';         -- Convert to EST/EDT
SELECT NOW() AT TIME ZONE 'Europe/London';            -- Convert to GMT/BST
SELECT NOW() AT TIME ZONE 'Asia/Tokyo';               -- Convert to JST

-- Current timezone
SHOW TIMEZONE;                                        -- Show session timezone
SET TIMEZONE = 'UTC';                                 -- Set session timezone

-- Store timestamp with timezone
CREATE TABLE events (
    event_id INT,
    event_time TIMESTAMPTZ                            -- Stores with TZ info
);

INSERT INTO events VALUES (1, '2024-01-15 14:30:00 -05:00');  -- EST

-- Query automatically converts to session timezone
SELECT event_time FROM events;                        -- Shows in session TZ
```

### Best Practices for Time Zones

```sql
-- ✅ GOOD: Store in UTC, display in local timezone
CREATE TABLE orders (
    order_id INT,
    created_at TIMESTAMPTZ DEFAULT NOW() AT TIME ZONE 'UTC'
);

-- Display in user's timezone
SELECT
    order_id,
    created_at AT TIME ZONE 'America/New_York' AS created_at_est
FROM orders;

-- ❌ BAD: Store without timezone (ambiguous)
CREATE TABLE orders (
    order_id INT,
    created_at TIMESTAMP  -- What timezone is this?
);
```

---

## Common Date Patterns

### Pattern 1: Start and End of Month

```sql
-- PostgreSQL
SELECT DATE_TRUNC('month', CURRENT_DATE) AS month_start;
SELECT (DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month - 1 day')::DATE AS month_end;

-- MySQL
SELECT DATE_FORMAT(CURRENT_DATE, '%Y-%m-01') AS month_start;
SELECT LAST_DAY(CURRENT_DATE) AS month_end;

-- SQL Server
SELECT DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0) AS month_start;
SELECT EOMONTH(GETDATE()) AS month_end;
```

### Pattern 2: Fiscal Year Calculations

```sql
-- Fiscal year starts July 1
SELECT
    CASE
        WHEN EXTRACT(MONTH FROM order_date) >= 7
        THEN EXTRACT(YEAR FROM order_date) + 1
        ELSE EXTRACT(YEAR FROM order_date)
    END AS fiscal_year,
    CASE
        WHEN EXTRACT(MONTH FROM order_date) >= 7
        THEN EXTRACT(MONTH FROM order_date) - 6
        ELSE EXTRACT(MONTH FROM order_date) + 6
    END AS fiscal_month
FROM orders;
```

### Pattern 3: Business Days Calculation

```sql
-- Days between dates excluding weekends
WITH dates AS (
    SELECT
        generate_series(
            '2024-01-01'::DATE,
            '2024-01-31'::DATE,
            '1 day'::INTERVAL
        )::DATE AS date
)
SELECT COUNT(*) AS business_days
FROM dates
WHERE EXTRACT(DOW FROM date) NOT IN (0, 6);  -- Exclude Sun(0) and Sat(6)
```

### Pattern 4: Age Calculation

```sql
-- Calculate age from birthdate
SELECT
    customer_id,
    birthdate,
    DATE_PART('year', AGE(birthdate)) AS age
FROM customers;

-- Or manually
SELECT
    customer_id,
    birthdate,
    (CURRENT_DATE - birthdate) / 365 AS age_approx
FROM customers;
```

### Pattern 5: Rolling Windows

```sql
-- Orders in last 30 days
SELECT *
FROM orders
WHERE order_date >= CURRENT_DATE - INTERVAL '30 days';

-- Revenue by month for last 12 months
SELECT
    DATE_TRUNC('month', order_date) AS month,
    SUM(total_amount) AS revenue
FROM orders
WHERE order_date >= DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '12 months'
GROUP BY DATE_TRUNC('month', order_date)
ORDER BY month;
```

### Pattern 6: Date Ranges and Overlaps

```sql
-- Find overlapping date ranges
SELECT
    e1.event_name AS event1,
    e2.event_name AS event2
FROM events e1
JOIN events e2 ON
    e1.event_id < e2.event_id
    AND e1.start_date < e2.end_date
    AND e1.end_date > e2.start_date;
```

### Pattern 7: Cohort Analysis

```sql
-- Monthly cohorts
SELECT
    DATE_TRUNC('month', signup_date) AS cohort_month,
    COUNT(DISTINCT customer_id) AS cohort_size,
    COUNT(DISTINCT CASE
        WHEN first_purchase_date - signup_date <= 7
        THEN customer_id
    END) AS purchased_within_7_days
FROM customers
GROUP BY DATE_TRUNC('month', signup_date)
ORDER BY cohort_month;
```

---

## Handling NULLs and Edge Cases

```sql
-- Handle NULL dates
SELECT
    COALESCE(last_login_date, '1900-01-01'::DATE) AS last_login,
    COALESCE(
        CURRENT_DATE - last_login_date,
        999999
    ) AS days_since_login
FROM users;

-- Validate date ranges
SELECT *
FROM events
WHERE start_date <= end_date  -- Ensure logical order
  AND start_date IS NOT NULL
  AND end_date IS NOT NULL;
```

---

## Performance Considerations

### Index Date Columns

```sql
-- Index for date range queries
CREATE INDEX idx_orders_date ON orders(order_date);

-- Partial index for recent data
CREATE INDEX idx_orders_recent ON orders(order_date)
WHERE order_date >= '2024-01-01';
```

### Avoid Functions on Indexed Columns

```sql
-- ❌ SLOW: Function prevents index use
SELECT * FROM orders
WHERE EXTRACT(YEAR FROM order_date) = 2024;

-- ✅ FAST: Range query uses index
SELECT * FROM orders
WHERE order_date >= '2024-01-01'
  AND order_date < '2025-01-01';

-- ❌ SLOW: DATE() prevents index use
SELECT * FROM orders
WHERE DATE(order_timestamp) = '2024-01-15';

-- ✅ FAST: Range query uses index
SELECT * FROM orders
WHERE order_timestamp >= '2024-01-15 00:00:00'
  AND order_timestamp < '2024-01-16 00:00:00';
```

---

## Common Pitfalls

### Pitfall 1: Time Zone Confusion

```sql
-- ❌ AMBIGUOUS: What timezone?
SELECT * FROM events
WHERE event_time > '2024-01-15 14:30:00';

-- ✅ EXPLICIT: Specify timezone
SELECT * FROM events
WHERE event_time > '2024-01-15 14:30:00 UTC';
```

### Pitfall 2: Incorrect Date Arithmetic

```sql
-- ❌ WRONG: Adds 30 days, not 1 month
SELECT CURRENT_DATE + 30;

-- ✅ CORRECT: Adds 1 calendar month
SELECT CURRENT_DATE + INTERVAL '1 month';
```

### Pitfall 3: String Comparison Instead of Date

```sql
-- ❌ BAD: String comparison
SELECT * FROM orders
WHERE order_date::TEXT > '2024-01-15';

-- ✅ GOOD: Date comparison
SELECT * FROM orders
WHERE order_date > '2024-01-15'::DATE;
```

---

## Best Practices Checklist

### ✅ Do's

1. **Store dates in UTC** (or TIMESTAMPTZ)
2. **Use DATE types** for dates (not VARCHAR)
3. **Index date columns** for range queries
4. **Avoid functions on indexed columns** in WHERE
5. **Use INTERVAL** for readable date arithmetic
6. **Extract timezone explicitly** when parsing
7. **Truncate dates** for grouping (DATE_TRUNC)

### ❌ Don'ts

1. **Don't store dates as strings** (TEXT/VARCHAR)
2. **Don't use ambiguous formats** ('01/02/2024' - Jan 2 or Feb 1?)
3. **Don't assume timezone** - always be explicit
4. **Don't compare dates as strings**
5. **Don't forget NULL handling**
6. **Don't use EXTRACT/YEAR() in WHERE** (kills index)

---

## Related Concepts

- [[Window Functions - Advanced SQL Analytics]] - Time-series analysis
- [[SQL Indexes - Performance Optimization]] - Indexing date columns
- [[Data Quality & Validation]] - Date validation
- [[SQL Basics - Quick Reference]] - Foundation SQL

---

## Key Takeaways

1. **Use appropriate data types** - DATE for dates, TIMESTAMP for date-time, TIMESTAMPTZ for multi-region
2. **Store in UTC**, convert for display
3. **DATE_TRUNC/DATETRUNC** for grouping by time periods
4. **INTERVAL arithmetic** is more readable than manual calculation
5. **Index date columns** and avoid functions in WHERE clauses
6. **Be explicit about timezones** to avoid ambiguity
7. **Range queries > function-based filters** for performance
8. **Extract date parts** for analysis (year, month, quarter, day of week)
